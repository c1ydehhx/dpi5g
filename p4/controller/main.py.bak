import time
from typing import List, Tuple

from bfrt_grpc.client import logger, logging

from initialize import initialize_switch_07, initialize_switch_08
from core.switch_controller import SwitchController
from model.port_info import PortInfo
from model.ue import UE, UEStatus
from model.upf import UPF
from model.ran import RAN
from model.data import Data
from switch_basic_init import switch_basic_init
from utils.hex_converter import mac_to_hex, ip_to_hex
from utils.data_fetcher import UPFID
from utils.LLF import LLF
from utils.uemgr import UEMgr

logger.setLevel(logging.CRITICAL)


def init_switch_07(switch: SwitchController):
    print("Initialize Switch 07")

    port_infos: tuple[PortInfo] = [
        PortInfo(  8, "192.168.43.11",  "90:e2:ba:c2:e7:76"),
        PortInfo( 11, "192.168.43.12",  "00:1b:21:bc:aa:36"),
        PortInfo( 44, "192.168.43.13",  "3c:fd:fe:01:34:46"),
        PortInfo(  9, "192.168.43.201", "90:e2:ba:c2:eb:fa"),
        PortInfo( 10, "192.168.43.202", "90:e2:ba:c2:f6:76"),
        PortInfo(  1, "192.168.43.101", "90:e2:ba:c2:ee:a6"),
        PortInfo(130, "192.168.43.204", "00:07:32:9c:6a:01"),
        PortInfo(131, "192.168.43.203", "00:07:32:9c:69:b1"),
        PortInfo(  2, "192.168.43.14",  "00:1b:21:bc:aa:34"),
    ]

    recirculation_ports = [
        PortInfo(49), 
        PortInfo(48), 
        PortInfo(51), 
        PortInfo(50),
        PortInfo(32),
        PortInfo(33),
        PortInfo(35),
        PortInfo(34),
    ]

    switch_basic_init(switch, port_infos)
    initialize_switch_07.init(switch, port_infos, recirculation_ports)


def init_switch_08(switch: SwitchController):
    print("Initialize Switch 08")

    port_infos: Tuple[PortInfo] = [
        PortInfo( 1, "10.10.216.102", "90:e2:ba:c2:ee:a4"),
        PortInfo( 8, "10.10.216.201", "90:e2:ba:c2:eb:f8"),
        PortInfo(10, "10.10.216.101", "00:1b:21:bc:aa:d3"),
        PortInfo(11, "10.10.216.202", "90:e2:ba:c2:f6:74"),
        PortInfo(129, "10.10.216.204", "00:07:32:9c:6a:02"),
        PortInfo(130, "10.10.216.203", "00:07:32:9c:69:b2")
    ]

    switch_basic_init(switch, port_infos)
    initialize_switch_08.init(switch, port_infos)


def main():
    sw07 = SwitchController("l2fwd", "192.168.132.107")
    sw08 = SwitchController("l2fwd", "192.168.132.108")

    init_switch_07(sw07)
    init_switch_08(sw08)

    discovered_ues: List[UE] = []
    available_upfs: List[UPF] = [
        UPF(UPFID.UPF01, "90:e2:ba:c2:eb:fa", "192.168.43.201", 9, 9500, 10400),
        UPF(UPFID.UPF02, "90:e2:ba:c2:f6:76", "192.168.43.202", 10, 9500, 10400),
        UPF(UPFID.UPF03, "00:07:32:9c:69:b1", "192.168.43.203", 131, 0, 900),
        UPF(UPFID.UPF04, "00:07:32:9c:6a:01", "192.168.43.204", 130, 0, 900)
    ]
    
    available_gnbs: List[RAN] = [
        RAN("192.168.132.31"),
        RAN("192.168.132.34"),
        RAN("192.168.132.46")
    ]
    
    llf = LLF(available_upfs)
    
    for TEID in range(2, 100, 2):
        upf_data = available_upfs[0]
        sw07.add_table_record(table_name="ue_packet_transmit_table",
            key_names=["hdr.gprs.teid", "hdr.ipv4.dstAddr"],
            key_vals=[TEID, ip_to_hex("192.168.43.200")],
            data_vals=[
                Data("dstMacAddr", mac_to_hex(upf_data.get_mac_addr())),
                Data("dstIPAddr", ip_to_hex(upf_data.get_ip_addr())),
                Data("output_port", upf_data.get_output_port()),
            ],
            action_name="transmit_ue_packet_to_specific_port"
        )
    
    for available_ip in range(32):
        ip_addr = ip_to_hex("10.10.216.33") + available_ip
        sw08.add_table_record(table_name="virtual_ip_arp_reply_table",
            key_names=["hdr.arp.tpa"],
            key_vals=[ip_addr],
            data_vals=[
                Data("replySPA", ip_addr),
                Data("replySHA", mac_to_hex("00:1b:06:AA:BB:CC")),
            ],
            action_name="virtual_ip_arp_reply"
        )
        sw08.add_table_record(table_name="virtual_ip_hdr_addr_replace_table",
            key_names=["hdr.ipv4.dstAddr", "hdr.ethernet.dstAddr"],
            key_vals=[ip_addr, mac_to_hex("00:1b:06:AA:BB:CC")],
            data_vals=[
                Data("dstAddr", mac_to_hex("90:e2:ba:c2:eb:f8")),
                Data("port", 8),
            ],
            action_name="replace_virtual_ip_hdr_addr_replace"
        )
        
    uemgr: UEMgr = UEMgr()

    while True:
        for gnb in available_gnbs:
            gnb.fetch_up_ues()
            for ue in gnb.up_ue_list:
                uemgr.register_ue_device_and_instance(ue["ip"], ue["device"], gnb.get_ip_addr())
            
        # Discovered Phase
        for TEID in range(2, 100, 2):
            ip_hex = sw07.get_register_val("ue_ip_reg", ["$REGISTER_INDEX"], [TEID])
            if ip_hex == 0:
                continue
            
            uemgr.register_ue_teid(ip_hex, TEID)
            ue: UE = uemgr.get_ue(ip_hex)
            
            if ue not in discovered_ues:
                print(f"""Discovery New UE with TEID {TEID} / IP {ue.get_ip_addr()} / Instance {ue.get_instance()} / Device {ue.get_device()}""")
                discovered_ues.append(ue)
    
        # discovered_ues = llf.match_lowest_upfs(discovered_ues)
        
        # for ue in discovered_ues:
        #     if(ip_to_hex("10.10.216.33") <= ue.get_ip_addr() <= ip_to_hex("10.10.216.36")):
        #         ue.binding_upf = "192.168.43.201"
        #     if(ip_to_hex("10.10.216.37") <= ue.get_ip_addr() <= ip_to_hex("10.10.216.40")):
        #         ue.binding_upf = "192.168.43.202"
        #     if(ip_to_hex("10.10.216.41") <= ue.get_ip_addr() <= ip_to_hex("10.10.216.44")):
        #         ue.binding_upf = "192.168.43.203"
        
        for ue in discovered_ues:
            ue.binding_upf = "192.168.43.201"
        
        for i in range(len(discovered_ues)):
            ue = discovered_ues[i]
            upf_data = available_upfs[ip_to_hex(ue.get_binding_upf()) - ip_to_hex("192.168.43.201")]
            print(f"[UPDATE_UPF_ROUTE] TEID {ue.teid} / IP {ue.ip_addr} --> UPF IP {upf_data.get_ip_addr()} / OUTPUT {upf_data.get_output_port()}")
            sw07.modify_table_record(table_name="ue_packet_transmit_table",
                key_names=["hdr.gprs.teid", "hdr.ipv4.dstAddr"],
                key_vals=[ue.get_teid(), ip_to_hex("192.168.43.200")],
                data_vals=[
                    Data("dstMacAddr", mac_to_hex(upf_data.get_mac_addr())),
                    Data("dstIPAddr", ip_to_hex(upf_data.get_ip_addr())),
                    Data("output_port", upf_data.get_output_port()),
                ],
                action_name="transmit_ue_packet_to_specific_port"
            )

main()